<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}"
>
  <th:block layout:fragment="css">
    <link rel="stylesheet" th:href="@{/css/fm/salary.css}" />
  </th:block>

  <div layout:fragment="content">
    <div class="erp-card">
      <div class="card-header">
        <h2>ì§ì› ê¸‰ì—¬ ì¡°íšŒ (Salary Management)</h2>
      </div>

      <div class="toolbar">
        <form th:action="@{/allSalary}" method="get" class="search-form">
          <input
            type="text"
            name="keyword"
            class="form-input"
            placeholder="ì‚¬ì› ì´ë¦„ ê²€ìƒ‰"
            th:value="${param.keyword}"
          />
          <button type="submit" class="btn-search">ê²€ìƒ‰</button>
        </form>

        <div class="action-group">
          <form th:action="@{/insert_salary}" method="post" class="pay-form">
            <label>ì§€ê¸‰ì¼</label>
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />
            <input
              type="date"
              name="payDate"
              class="form-input"
              th:value="${#dates.format(#dates.createNow(),'yyyy-MM-dd')}"
              required
            />
            <button
              type="submit"
              class="btn-pay"
              onclick="return confirm('ì •ë§ ì¼ê´„ ì§€ê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
            >
              ğŸ’° ì¼ê´„ ì§€ê¸‰
            </button>
          </form>

          <button
            type="button"
            class="btn-stub"
            th:onclick="|location.href='@{/sendSalary}'|"
          >
            ğŸ“„ ê¸‰ì—¬ ì¼ê´„ ì¡°íšŒ
          </button>
        </div>
      </div>

      <table class="styled-table">
        <thead>
          <tr>
            <th>ìœ ì € ì´ë¦„</th>
            <th>ê¸°ë³¸ ê¸‰ì—¬</th>
            <th>ê¸‰ì—¬ ì¡°ì •</th>
            <th>ìƒì„¸ ì •ë³´</th>
          </tr>
        </thead>
        <tbody>
          <tr th:if="${vo.isEmpty()}">
            <td colspan="4" style="text-align: center">
              ë“±ë¡ëœ ì‚¬ì›ì´ ì—†ìŠµë‹ˆë‹¤.
            </td>
          </tr>

          <tr th:each="emp : ${vo}">
            <td th:text="${emp.name}" style="font-weight: bold">í™ê¸¸ë™</td>

            <td
              class="money"
              th:text="${#numbers.formatInteger(emp.baseSalary, 0, 'COMMA') + 'ì›'}"
            >
              2,000,000ì›
            </td>

            <td style="text-align: center">
              <button
                type="button"
                class="btn-small btn-edit"
                th:onclick="openEditModal([[${emp.empId}]])"
              >
                ìˆ˜ì •
              </button>
            </td>
            <td style="text-align: center">
              <button
                type="button"
                class="btn-small btn-info"
                th:onclick="openSalaryModal([[${emp.empId}]])"
              >
                ê°œì¸ ê¸‰ì—¬
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!--ê°œì¸ê¸‰ì—¬ëª¨ë‹¬ë¶€ë¶„-->
      <div id="salaryModal" class="modal-overlay hidden">
        <div class="modal-content salary-modal-size">
          <div class="modal-header">
            <h3>ê°œì¸ ê¸‰ì—¬ ìƒì„¸</h3>
            <button
              type="button"
              class="close-btn"
              onclick="closeSalaryModal()"
            >
              &times;
            </button>
          </div>

          <div class="modal-body" id="salary-modal-body">
            <div style="text-align: center; padding: 20px">ë¡œë”©ì¤‘... â³</div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn-close"
              onclick="closeSalaryModal()"
            >
              ë‹«ê¸°
            </button>
          </div>
        </div>
      </div>

      <!--ê¸‰ì—¬ìˆ˜ì •ëª¨ë‹¬ë¶€ë¶„-->
      <div id="editModal" class="modal-overlay hidden">
        <div class="modal-content" style="width: 400px">
          <div class="modal-header">
            <h3>ê¸‰ì—¬ ìˆ˜ì •</h3>
            <button type="button" class="close-btn" onclick="closeEditModal()">
              &times;
            </button>
          </div>
          <div class="modal-body" id="edit-modal-body">
            <div style="text-align: center; padding: 20px">ë¡œë”©ì¤‘... â³</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-close" onclick="closeEditModal()">
              ì·¨ì†Œ
            </button>
          </div>
        </div>
      </div>

      <!--í˜ì´ì§•-->
      <nav class="pagination-container">
        <ul class="pagination">
          <li class="page-item" th:classappend="${!paging.prev} ? ' disabled'">
            <a
              class="page-link"
              th:href="@{/allSalary(keyword=${param.keyword}, page=${paging.startPage - 1})}"
            >
              Previous
            </a>
          </li>

          <li
            th:if="${paging.endPage > 0}"
            th:each="pageNum : ${#numbers.sequence(paging.startPage, paging.endPage)}"
            class="page-item"
            th:classappend="${pageNum == paging.page} ? ' active'"
          >
            <a
              class="page-link"
              th:href="@{/allSalary(keyword=${param.keyword}, page=${pageNum})}"
              th:text="${pageNum}"
              >1</a
            >
          </li>

          <li class="page-item" th:classappend="${!paging.next} ? ' disabled'">
            <a
              class="page-link"
              th:href="@{/allSalary(keyword=${param.keyword}, page=${paging.endPage + 1})}"
            >
              Next
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <div layout:fragment="script">
    <script th:inline="javascript">
      function openSalaryModal(empId) {
        const modal = document.getElementById("salaryModal");
        const body = document.getElementById("salary-modal-body");

        // ëª¨ë‹¬ ì—´ê¸°
        modal.classList.remove("hidden");
        body.innerHTML =
          '<div style="text-align:center; padding: 50px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';

        // AJAX ìš”ì²­ (HTML ì¡°ê° ê°€ì ¸ì˜¤ê¸°)
        fetch("/salary/history?empId=" + empId)
          .then((response) => {
            if (!response.ok) throw new Error("í†µì‹  ì‹¤íŒ¨!");
            return response.text();
          })
          .then((html) => {
            body.innerHTML = html; // ë‚´ìš© ê°ˆì•„ë¼ìš°ê¸°
          })
          .catch((err) => {
            console.error(err);
            body.innerHTML =
              '<div style="text-align:center; color:red; padding: 30px;">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
          });
      }

      function closeSalaryModal() {
        document.getElementById("salaryModal").classList.add("hidden");
        // ë‚´ìš© ë¹„ìš°ê¸° (ì„ íƒì‚¬í•­)
        setTimeout(() => {
          document.getElementById("salary-modal-body").innerHTML = "";
        }, 300);
      }

      // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
      document
        .getElementById("salaryModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeSalaryModal();
        });

      function openEditModal(empId) {
        const modal = document.getElementById("editModal");
        const body = document.getElementById("edit-modal-body");

        modal.classList.remove("hidden");
        body.innerHTML =
          '<div style="text-align:center; padding: 20px;">ë¡œë”©ì¤‘...</div>';

        fetch("/salary/update?empId=" + empId)
          .then((res) => {
            if (!res.ok) throw new Error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            return res.text();
          })
          .then((html) => {
            body.innerHTML = html;
          })
          .catch((err) => {
            console.error(err);
            body.innerHTML = "ì—ëŸ¬ ë°œìƒ!";
          });
      }

      // 2. ëª¨ë‹¬ ë‹«ê¸°
      function closeEditModal() {
        document.getElementById("editModal").classList.add("hidden");
      }

      // 3. ğŸ”¥ [í•µì‹¬] ê¸‰ì—¬ ìˆ˜ì • AJAX ìš”ì²­ (í¼ ì œì¶œ ì‹œ ì‹¤í–‰)
      function updateSalary(event) {
        event.preventDefault(); // í¼ì˜ ê¸°ë³¸ ì œì¶œ(ìƒˆë¡œê³ ì¹¨) ë§‰ê¸°!

        const form = document.getElementById("salaryUpdateForm");
        const formData = new FormData(form);

        // FormDataë¥¼ URLSearchParamsë¡œ ë³€í™˜ (Controllerê°€ DTOë¡œ ë°›ê¸° í¸í•¨)
        // í˜¹ì€ JSONìœ¼ë¡œ ë³´ë‚´ë„ ë˜ì§€ë§Œ, DTO ë§¤í•‘ì—” ì´ê²Œ í¸í•  ë•Œê°€ ë§ìŒ
        const params = new URLSearchParams(formData);

        fetch("/update_salary", {
          // ê¸°ì¡´ URL ì¬ì‚¬ìš©
          method: "POST",
          body: params,
          // CSRF í† í°ì€ form ì•ˆì— hidden inputìœ¼ë¡œ ì´ë¯¸ ë“¤ì–´ìˆì–´ì„œ paramsì— í¬í•¨ë¨!
        })
          .then((res) => {
            if (res.ok) {
              alert("ê¸‰ì—¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’°");
              closeEditModal();
              location.reload(); // ëª©ë¡ ê°±ì‹ ì„ ìœ„í•´ ìƒˆë¡œê³ ì¹¨ (í˜¹ì€ ë¶€ë¶„ ê°±ì‹ )
            } else {
              alert("ìˆ˜ì • ì‹¤íŒ¨! ê°’ì„ í™•ì¸í•˜ì„¸ìš”.");
            }
          })
          .catch((err) => {
            console.error(err);
            alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ!");
          });

        return false;
      }
    </script>
  </div>
</html>
