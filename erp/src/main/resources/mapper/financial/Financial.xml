<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.java.erp.fm.dao.FinancialDAO">


    <select id="total" parameterType="com.java.erp.commons.model.dto.SearchDTO" resultType="int">
        SELECT count(*)
        FROM transaction
        <where>
            <if test="transType != null and transType != ''">
                AND trans_type = #{transType}
            </if>

            <if test="category != null and category != ''">
                AND category = #{category}
            </if>

            <if test="fromDate != null and toDate == null">
                AND trans_date &gt;= #{fromDate}
            </if>

            <if test="fromDate != null and toDate != null">
                AND trans_date BETWEEN #{fromDate} AND #{toDate}
            </if>
        </where>
    </select>

    <select id="salaryTotal" parameterType="com.java.erp.commons.model.dto.SearchDTO" resultType="int">
        SELECT count(*)
        FROM employee
        <where>
            status != 'resigned'
            <if test="search.keyword != null and search.keyword != ''">
               AND name LIKE CONCAT('%', #{search.keyword}, '%')
            </if>
        </where>
    </select>

    <select id="locationTotal" parameterType="com.java.erp.commons.model.dto.SearchDTO" resultType="int">
        SELECT count(*)
        FROM location l
        LEFT JOIN rent_reservation r
        ON l.location_id = r.location_id
        <where>
            <if test="search.keyword != null and search.keyword != ''">
                AND location_name LIKE CONCAT('%', #{search.keyword}, '%')
            </if>
        </where>
    </select>

    <select id="sendSalaryTotal" resultType="int">
        SELECT count(*)
        FROM salary
    </select>

    <!-- 수입 / 지출 회계 기록 조회 페이지 -->
    <select id="selectAll" resultType="TransactionVO">
        select * from transaction
        <where>
            <if test="search.transType != null and search.transType != ''">
                AND trans_type = #{search.transType}
            </if>

            <if test="search.category != null and search.category != ''">
                AND category = #{search.category}
            </if>

            <if test="search.fromDate != null and search.toDate == null">
                AND trans_date &gt;= #{search.fromDate}
            </if>

            <if test="search.fromDate != null and search.toDate != null">
                AND trans_date BETWEEN #{search.fromDate} AND #{search.toDate}
            </if>
        </where>
        LIMIT #{paging.offset}, #{paging.limit};
    </select>

    <!-- 직원 급여 조회 페이지 -->
    <select id="allSalary" resultType="emp">
        select * from employee
        <where>
            status != 'resigned'
            <if test="search.keyword != null and search.keyword != ''">
                AND name LIKE CONCAT('%', #{search.keyword}, '%')
            </if>
        </where>
        LIMIT #{paging.offset}, #{paging.limit};
    </select>

    <!-- 직원 급여 수정 페이지 조회 -->
    <select id="selectSalary" resultType="emp" parameterType="int">
        select * from employee where emp_id = #{empId}
    </select>

    <!-- 직원 급여 수정 -->
    <update id="updateSalary" parameterType="emp">
        UPDATE employee
        SET base_salary = #{baseSalary}
        WHERE emp_id = #{empId}
    </update>

    <!-- 직원 급여 전체 지급 -->
    <insert id="insertSalary" parameterType="SalaryDTO">
        INSERT INTO salary (emp_id, deduction, total_salary, salary_date)
        SELECT
        e.emp_id,
        ROUND(COALESCE(e.base_salary,0) * 0.033)              AS deduction,  <!-- 공제금액 계산 -->
        ROUND(COALESCE(e.base_salary,0) - COALESCE(e.base_salary,0) * 0.033) AS total_salary,
        #{payDate}                                             AS salary_date
        FROM employee e
        LEFT JOIN salary s
        ON s.emp_id = e.emp_id
        AND YEAR(s.salary_date)  = YEAR(#{payDate})
        AND MONTH(s.salary_date) = MONTH(#{payDate})
        WHERE s.salary_id IS NULL
        <!-- 입사 ≤ 지급일 -->
        AND (
        e.hire_date IS NULL
        OR <![CDATA[ e.hire_date <= #{payDate} ]]>
        )
        <!-- 퇴사 ≥ 지급일 -->
        AND (
        e.resign_date IS NULL
        OR <![CDATA[ e.resign_date >= #{payDate} ]]>
        )
    </insert>

    <!-- 급여 지급된 지원 목록 -->
    <select id="totalSalary" resultType="SalaryVO">
        select * from salary
        LIMIT #{paging.offset}, #{paging.limit};
    </select>

    <!-- 드롭다운용 카테고리 목록 -->
    <select id="selectDistinctCategories" resultType="string">
            <![CDATA[
        SELECT DISTINCT category
        FROM transaction
        WHERE category IS NOT NULL AND category <> ''
        ORDER BY category
      ]]>
    </select>

    <select id="selectDistinctCategoriesByType" parameterType="string" resultType="string">
            <![CDATA[
        SELECT DISTINCT category
        FROM transaction
        WHERE category IS NOT NULL AND category <> ''
          AND trans_type = #{transType}
        ORDER BY category
      ]]>
    </select>

    <!-- 조건 검색 -->
    <select id="searchTransactions" resultType="TransactionVO">
        SELECT
        trans_id, trans_type, trans_amount, category, trans_desc, trans_date
        FROM transaction
        <where>
            <if test="transType != null and transType != ''">
                AND trans_type = #{transType}
            </if>
            <if test="category != null and category != ''">
                AND category = #{category}
            </if>
            <choose>
                <when test="fromDate != null and toDate != null">
                    <![CDATA[
                      AND trans_date BETWEEN #{fromDate} AND #{toDate}
                    ]]>
                </when>
                <otherwise>
                    <if test="fromDate != null">
                        <![CDATA[ AND trans_date >= #{fromDate} ]]>
                    </if>
                    <if test="toDate != null">
                        <![CDATA[ AND trans_date <= #{toDate} ]]>
                    </if>
                </otherwise>
            </choose>
        </where>
        ORDER BY trans_date DESC, trans_id DESC
    </select>

    <select id="oneSalary" resultType="SalaryVO" parameterType="int">
        select * from salary
        where emp_id = #{empId}
    </select>

    <!-- 임대 광고 수수료 조회 페이지 -->
    <select id="selectRentalFee" resultType="RentalFeeDTO">
        SELECT
        l.location_id,
        l.location_name,
        r.rent_start,
        r.rent_end,
        r.rental_fee,
        DATEDIFF(r.rent_end, r.rent_start) + 1 AS rent_days,
        10000 * (DATEDIFF(r.rent_end, r.rent_start) + 1) AS ad_cost
        FROM location l
        LEFT JOIN rent_reservation r
        ON l.location_id = r.location_id
        <where>
            <if test="search.keyword != null and search.keyword != ''">
                AND location_name LIKE CONCAT('%', #{search.keyword}, '%')
            </if>
        </where>
        LIMIT #{paging.offset}, #{paging.limit};
    </select>
</mapper>












